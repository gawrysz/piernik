# Setup call:
#     ./setup sedov -o deadlock  -p problem.par.___DEADLOCK___

# With OpenMPI 5.0.x this configuration _almost always_ stalls due to a deadlock in one of MPI_Waitall
# calls. It happens most often in cg_list_bnd::internal_boundaries_MPI_1by1
# subroutine after nstep = 5. To reproduce try:
#     cd runs/sedov_deadlock
#     mpirun -np 3 ./piernik
# If it goes past 5th step, try few more times to make sure that the problem
# doesn't occur in your environment.

 $BASE_DOMAIN
    n_d = 3*32
    bnd_xl = 'ref'
    bnd_xr = 'out'
    bnd_yl = 'ref'
    bnd_yr = 'ref'
    bnd_zl = 'ref'
    bnd_zr = 'ref'
    xmin   = -1.
    xmax   =  1.
    ymin   = -1.
    ymax   =  1.
    zmin   = -1.
    zmax   =  1.
 /

 $MPI_BLOCKS
 /

 $UNITS
 /

 $RESTART_CONTROL
    restart  = 'last'
    res_id   = ''
    nrestart = 0
 /

 $END_CONTROL
    tend   = 0.1
    nend   = 100
 /

 $OUTPUT_CONTROL
!    verbosity = "verbose"
    problem_name = 'sedov'
    run_id =  'tst'
    dt_hdf  = 0.00
    dt_res  = 0.0
    dt_log  = 0.0001
    dt_tsl  = 1.e-10
    vars(1:) = 'ener', 'dens', 'level', 'velx', 'vely', 'velz'
 /

 $FLUID_IONIZED
    gamma  = 1.666666666
 /

 $FLUID_NEUTRAL
    gamma = 1.666666666
 /

 $NUMERICAL_SETUP
    cfl    = 0.7
    smalld = 1.e-3
    smallei= 1.e-5
    limiter= 'vanleer'
    solver_str = "Riemann"
 /

 $GRAVITY
 /

 $PROBLEM_CONTROL
    d0     = 1.0
    p0     = 1.0
    Eexpl  = 1.e6
    bx0    = 0.0
    by0    = 0.0
    bz0    = 0.0
    x0     = 0.
    y0     = 0.
    z0     = 0.
    r0     = 0.25
    dtrig  = 1.5
    ref_thr = 0.3
 /

 $MULTIGRID_SOLVER
 /

 $INTERACTIONS
 /


 $FLUID_TRACER
 /

 $AMR
    bsize = 3*16
    level_max = 4
    n_updAMR = 1
!    oop_thr = .01
 /

 $BALANCE
!  n_rebalance = 1
  flexible_balance = T
!    VERBOSITY_NSTEP=1
   VERBOSITY=2
!   BALANCE_THREAD=T
!   balance_host = 1.
!   balance_cg = 1.
 /

 $PARALLEL_SETUP
   prefer_merged_MPI = F  ! MPI 1by1 is causing problems
!   EXTRA_BARRIERS=T
   MPI_wrapper_stats = T
   waitall_timeout = 10.
 /
